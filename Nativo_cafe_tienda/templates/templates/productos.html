<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productos - Nativo Café</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
            padding: 20px 0;
        }
        
        .product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid #e9ecef;
        }
        
        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .product-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            background: #f8f9fa;
        }
        
        .product-info {
            padding: 20px;
        }
        
        .product-name {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            margin: 0 0 8px 0;
        }
        
        .product-description {
            color: #6c757d;
            font-size: 14px;
            margin: 8px 0;
            line-height: 1.5;
        }
        
        .product-price {
            font-size: 24px;
            font-weight: bold;
            color: #8B4513;
            margin: 12px 0;
        }
        
        .product-category {
            display: inline-block;
            background: #f8f9fa;
            color: #495057;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            text-transform: uppercase;
            font-weight: 500;
            margin-bottom: 12px;
        }
        
        .product-stock {
            font-size: 14px;
            color: #6c757d;
            margin: 8px 0;
        }
        
        .stock-low {
            color: #dc3545;
            font-weight: 500;
        }
        
        .stock-out {
            color: #dc3545;
            font-weight: bold;
        }
        
        .add-to-cart-btn {
            width: 100%;
            background: #8B4513;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .add-to-cart-btn:hover:not(:disabled) {
            background: #6d3410;
        }
        
        .add-to-cart-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 12px 0;
        }
        
        .quantity-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .quantity-btn:hover {
            background: #f8f9fa;
        }
        
        .quantity-input {
            width: 60px;
            text-align: center;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 6px;
        }
        
        .cart-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }
        
        .cart-sidebar.active {
            right: 0;
        }
        
        .cart-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .cart-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .cart-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cart-title {
            margin: 0;
            color: #2c3e50;
        }
        
        .close-cart {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }
        
        .cart-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .cart-item {
            display: flex;
            gap: 12px;
            padding: 16px 0;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .cart-item-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .cart-item-info {
            flex: 1;
        }
        
        .cart-item-name {
            font-weight: 600;
            color: #2c3e50;
            margin: 0 0 4px 0;
        }
        
        .cart-item-price {
            color: #8B4513;
            font-weight: 500;
        }
        
        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        
        .cart-footer {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
        }
        
        .cart-total {
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 16px;
            color: #2c3e50;
        }
        
        .checkout-btn {
            width: 100%;
            background: #28a745;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .checkout-btn:hover:not(:disabled) {
            background: #218838;
        }
        
        .checkout-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .cart-icon {
            position: relative;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.3s ease;
        }
        
        .cart-icon:hover {
            background: rgba(139, 69, 19, 0.1);
        }
        
        .cart-count {
            position: absolute;
            top: 0;
            right: 0;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .empty-cart {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .empty-products {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        @media (max-width: 768px) {
            .cart-sidebar {
                width: 100%;
                right: -100%;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Notificación -->
    <div id="notification" class="notification"></div>
    
    <!-- Header -->
    <header>
        <nav>
            <a href="/" class="logo">
            <img src="/static/img/aa.png" alt="Nativo Café Logo" class="logo-img">
            </a>
            
            <ul class="menu">
                <li><a href="/">Inicio</a></li>
                <li><a href="/productos" style="color: #8B4513; font-weight: bold;">Productos</a></li>
                <li><a href="/sobre-nosotros">Sobre Nosotros</a></li>
                <li><a href="/equipo">Equipo</a></li>
                <li><a href="/menu">Menú</a></li>
                <li><a href="/ubicacion">Ubicación</a></li>
            </ul>
            
            <div class="nav-icons">
                <button class="cart-icon" id="cartIcon" onclick="toggleCart()">
                    🛒
                    <span class="cart-count" id="cartCount">0</span>
                </button>
                
                <div class="user-dropdown">
                    <button class="user-dropdown-btn" id="userDropdownBtn">
                        <div class="user-avatar" id="userAvatar"></div>
                        <span class="user-name" id="userName">Usuario</span>
                        <span class="dropdown-arrow">▼</span>
                    </button>
                    
                    <div class="user-dropdown-menu" id="userDropdownMenu">
                        <a href="#" onclick="showProfileModal()">
                            👤 Perfil
                        </a>
                        <a href="#" onclick="showModal('changePasswordModal')">
                            ⚙️ Configuración
                        </a>
                        <a href="/admin" id="adminLink" style="display: none;">
                            🛠️ Panel Admin
                        </a>
                        <hr>
                        <a href="#" onclick="logout()">
                            🚪 Cerrar Sesión
                        </a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Page Header -->
        <div class="page-header">
            <h1>Nuestros Productos</h1>
            <p>Descubre toda nuestra selección de cafés premium</p>
        </div>

        <!-- Products Section -->
        <section class="section">
            <div class="container">
                <div class="loading" id="productsLoading">
                    Cargando productos...
                </div>
                <div class="products-grid" id="allProductsGrid" style="display: none;">
                    <!-- Los productos se cargarán dinámicamente -->
                </div>
                <div class="empty-products" id="emptyProducts" style="display: none;">
                    <h3>No hay productos disponibles</h3>
                    <p>Vuelve pronto para ver nuestros cafés premium</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Cart Sidebar -->
    <div class="cart-overlay" id="cartOverlay" onclick="closeCart()"></div>
    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <h3 class="cart-title">Tu Carrito</h3>
            <button class="close-cart" onclick="closeCart()">×</button>
        </div>
        
        <div class="cart-content">
            <div id="cartItems">
                <div class="empty-cart">
                    <h4>Tu carrito está vacío</h4>
                    <p>Agrega algunos productos para comenzar</p>
                </div>
            </div>
        </div>
        
        <div class="cart-footer">
            <div class="cart-total">
                <span>Total: </span>
                <span id="cartTotal">Q0.00</span>
            </div>
            <button class="checkout-btn" id="checkoutBtn" onclick="showCheckout()" disabled>
                Proceder al Checkout
            </button>
            <button class="btn btn-secondary btn-full" onclick="clearCart()" style="margin-top: 0.5rem;">
                Limpiar Carrito
            </button>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkoutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirmar Pedido</h2>
                <button class="close-modal" onclick="closeCheckout()">×</button>
            </div>
            
            <div class="modal-body">
                <div id="checkoutSummary">
                    <!-- Resumen del pedido se cargará aquí -->
                </div>
                
                <form id="checkoutForm" onsubmit="handleCheckout(event)">
                    <div class="form-group">
                        <label for="customer_name">Nombre Completo</label>
                        <input type="text" id="customer_name" name="customer_name" required>
                    </div>
                    
                    <div class="form-group" id="emailGroup">
                        <label for="customer_email">Correo Electrónico</label>
                        <input type="email" id="customer_email" name="customer_email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="customer_phone">Teléfono</label>
                        <input type="tel" id="customer_phone" name="customer_phone" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="customer_address">Dirección de Entrega</label>
                        <textarea id="customer_address" name="customer_address" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="customer_notes">Notas Adicionales (Opcional)</label>
                        <textarea id="customer_notes" name="customer_notes" rows="2" placeholder="Instrucciones especiales para la entrega..."></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-full">
                        Confirmar Pedido
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Perfil -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Mi Perfil</h2>
                <button class="close-modal" onclick="closeModal('profileModal')">×</button>
            </div>
            
            <div class="modal-body">
                <div class="profile-section">
                    <div class="profile-photo-section">
                        <div class="current-photo" id="currentPhoto">
                            <div class="user-avatar large" id="profileAvatar"></div>
                        </div>
                        <div class="photo-upload">
                            <input type="file" id="photoUpload" accept="image/*" style="display: none;">
                            <button class="btn btn-secondary" onclick="document.getElementById('photoUpload').click()">
                                📷 Cambiar Foto
                            </button>
                        </div>
                    </div>
                    
                    <div class="profile-info">
                        <div class="form-group">
                            <label>Nombre</label>
                            <input type="text" id="profileName" readonly>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="profileEmail" readonly>
                        </div>
                        <div class="form-group">
                            <label>Rol</label>
                            <input type="text" id="profileRole" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Cambiar Contraseña</h2>
                <button class="close-modal" onclick="closeModal('changePasswordModal')">×</button>
            </div>
            
            <form id="changePasswordForm">
                <div class="form-group">
                    <label for="current_password">Contraseña Actual</label>
                    <input type="password" id="current_password" name="current_password" required>
                </div>
                
                <div class="form-group">
                    <label for="new_password">Nueva Contraseña</label>
                    <input type="password" id="new_password" name="new_password" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label for="confirm_password">Confirmar Nueva Contraseña</label>
                    <input type="password" id="confirm_password" name="confirm_password" required>
                </div>
                
                <button type="submit" class="btn btn-primary btn-full">
                    Cambiar Contraseña
                </button>
            </form>
        </div>
    </div>
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <script src="{{ url_for('static', filename='js/firebase-app.js') }}"></script>
    <script>
        // Variables globales para productos (página específica)
        let allProducts = [];

        // Inicializar la página de productos
        document.addEventListener('DOMContentLoaded', function() {
            // Esperar a que Firebase se inicialice globalmente
            setTimeout(() => {
                loadProductsPage();
            }, 1000);
        });

        // Cargar productos específicamente para esta página
        async function loadProductsPage() {
            try {
                console.log('Cargando productos para página de productos...');
                
                // Consulta simplificada sin filtros complejos
                const productsSnapshot = await db.collection('products').get();
                allProducts = [];
                
                productsSnapshot.forEach(doc => {
                    const productData = doc.data();
                    // Solo agregar productos con stock disponible
                    if (productData.stock > 0) {
                        allProducts.push({
                            id: doc.id,
                            ...productData
                        });
                    }
                });
                
                console.log('Productos cargados para página:', allProducts.length);
                renderProducts();
                
            } catch (error) {
                console.error('Error cargando productos:', error);
                showNotification('Error cargando productos', 'error');
                document.getElementById('productsLoading').style.display = 'none';
                document.getElementById('emptyProducts').style.display = 'block';
            }
        }

        // Renderizar productos en la página
        function renderProducts() {
            const grid = document.getElementById('allProductsGrid');
            const loading = document.getElementById('productsLoading');
            const empty = document.getElementById('emptyProducts');

            loading.style.display = 'none';

            if (allProducts.length === 0) {
                empty.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            grid.innerHTML = allProducts.map(product => `
                <div class="product-card">
                    <img src="${product.imageUrl || product.image || '/static/img/placeholder.jpg'}" 
                         alt="${product.name}" class="product-image">
                    <div class="product-info">
                        <span class="product-category">${product.category || 'General'}</span>
                        <h3 class="product-name">${product.name}</h3>
                        <p class="product-description">${product.description || ''}</p>
                        <p class="product-price">Q${product.price.toFixed(2)}</p>
                        <p class="product-stock ${product.stock <= 5 ? 'stock-low' : ''}">
                            ${product.stock > 0 ? `Stock: ${product.stock} unidades` : 'Agotado'}
                        </p>
                        
                        <button class="add-to-cart-btn" 
                                onclick="addToCart('${product.id}')"
                                ${product.stock <= 0 ? 'disabled' : ''}>
                            ${product.stock <= 0 ? 'Agotado' : 'Agregar al Carrito'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Función para cerrar checkout
        function closeCheckout() {
            closeModal('checkoutModal');
        }
    </script>
</body>
</html>