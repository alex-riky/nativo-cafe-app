<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Nativo Caf√©</title>
 <link rel="stylesheet" href="{{ url_for("static", filename="css/styles.css") }}">
  <link rel="stylesheet" href="{{ url_for("static", filename="css/style_admin.css") }}">
</head>
<body>
    <!-- Notificaci√≥n -->
    <div id="notification" class="notification"></div>
    
    <!-- Header -->
    <header>
        <nav>
            <a href="/" class="logo">
            <img src="/static/img/aa.png" alt="Nativo Caf√© Logo" class="logo-img">
            </a>
            
            <ul class="menu">
                <li><a href="/">Inicio</a></li>
                <li><a href="/productos">Productos</a></li>
                <li><a href="/admin" style="color: #dc3545; font-weight: bold;">Panel Admin</a></li>
            </ul>
            
            <div class="nav-icons">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar"></div>
                    <span class="user-name" id="userName"></span>
                    <span class="admin-badge" id="adminBadge">Admin</span>
                    <button class="logout-btn" onclick="logout()">Salir</button>
                </div>
            </div>
        </nav>
    </header>

    <!-- Firebase CDN -->
    <script src="{{ url_for("static", filename="js/firebase-app.js") }}"></script>
      <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <!-- Main Content -->
    <main>
        <div class="admin-container">
            <div class="admin-header">
                <h1>Panel de Administraci√≥n</h1>
                <p>Gestiona tu tienda Nativo Caf√©</p>
            </div>

            <!-- Estad√≠sticas -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <h3>Clientes Registrados</h3>
                    <p class="stat-value" id="totalCustomers">0</p>
                    <div class="stat-change positive">
                        <span>‚Üó</span> +12% este mes
                    </div>
                </div>
                
                <div class="stat-card">
                    <h3>Empleados</h3>
                    <p class="stat-value" id="totalEmployees">0</p>
                    <div class="stat-change positive">
                        <span>‚Üó</span> +2 nuevos
                    </div>
                </div>
                
                <div class="stat-card">
                    <h3>Ingresos Totales</h3>
                    <p class="stat-value" id="totalRevenue">Q0.00</p>
                    <div class="stat-change positive">
                        <span>‚Üó</span> +8.5% este mes
                    </div>
                </div>
                
                <div class="stat-card">
                    <h3>Ganancias Reales</h3>
                    <p class="stat-value" id="totalProfit">Q0.00</p>
                    <div class="stat-change positive">
                        <span>‚Üó</span> Despu√©s de costos
                    </div>
                </div>
                
                <div class="stat-card">
                    <h3>Total Productos</h3>
                    <p class="stat-value" id="totalProducts">0</p>
                    <div class="stat-change">
                        <span>‚Üí</span> Sin cambios
                    </div>
                </div>
                
                <div class="stat-card">
                    <h3>Total √ìrdenes</h3>
                    <p class="stat-value" id="totalOrders">0</p>
                    <div class="stat-change positive">
                        <span>‚Üó</span> +15% esta semana
                    </div>
                </div>
            </div>

            <!-- Gesti√≥n de Productos -->
            <div class="admin-section">
                <div class="section-header">
                    <h2>Gesti√≥n de Productos</h2>
                    <button class="btn btn-primary" onclick="showAddProductModal()">Agregar Producto</button>
                </div>
                
                <div class="products-table-container">
                    <table class="products-table" id="productsTable">
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>Nombre</th>
                                <th>Categor√≠a</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <!-- Los productos se cargar√°n din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- √ìrdenes Recientes -->
            <div class="admin-section">
                <div class="section-header">
                    <h2>√ìrdenes Recientes</h2>
                </div>
                
                <div class="orders-table-container">
                    <table class="orders-table" id="ordersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Cliente</th>
                                <th>Fecha</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Las √≥rdenes se cargar√°n din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Gesti√≥n de Empleados (Solo Admin) -->
            <div class="admin-section" id="employeesSection" style="display: none;">
                <div class="section-header">
                    <h2>Gesti√≥n de Empleados</h2>
                    <button class="btn btn-primary" onclick="showCreateEmployeeModal()">
                        Crear Empleado
                    </button>
                </div>
                <div class="section-content">
                    <div class="employee-section">
                        <div id="employeesList">
                            <!-- Los empleados se cargar√°n din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Agregar Nuevo Producto</h2>
                <button class="close-modal" onclick="closeModal('addProductModal')">√ó</button>
            </div>
            
            <form id="addProductForm" onsubmit="handleAddProduct(event)">
                <div class="form-group">
                    <label for="productName">Nombre del Producto</label>
                    <input type="text" id="productName" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="productDescription">Descripci√≥n</label>
                    <textarea id="productDescription" name="description" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="productPrice">Precio de Venta (Q)</label>
                    <input type="number" id="productPrice" name="price" step="0.01" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="productCostPrice">Precio de Costo (Q)</label>
                    <input type="number" id="productCostPrice" name="cost_price" step="0.01" min="0" required>
                    <small style="color: #666; font-size: 12px;">Este precio se usa para calcular las ganancias reales</small>
                </div>
                
                <div class="form-group">
                    <label for="productCategory">Categor√≠a</label>
                    <select id="productCategory" name="category" required>
                        <option value="">Seleccionar categor√≠a</option>
                        <option value="especial">Especial</option>
                        <option value="tradicional">Tradicional</option>
                        <option value="organico">Org√°nico</option>
                        <option value="descafeinado">Descafeinado</option>
                        <option value="molido">Molido</option>
                        <option value="grano">Grano Entero</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="productStockInput">Stock Inicial</label>
                    <input type="number" id="productStockInput" name="stock" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="productImageInput">Imagen del Producto</label>
                    <div class="image-upload-area">
                        <label for="productImageInput" class="upload-label">
                            üì∑ Seleccionar imagen
                        </label>
                        <input type="file" id="productImageInput" accept="image/*" onchange="previewImage(event)">
                        <input type="hidden" id="imageUrl" name="image_url">
                    </div>
                    <img id="imagePreview" class="image-preview" alt="Preview" style="display: none; max-width: 200px; margin-top: 10px;">
                </div>
                
                <button type="submit" class="btn btn-primary btn-full">
                    Agregar Producto
                </button>
            </form>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Producto</h2>
                <button class="close-modal" onclick="closeModal('editProductModal')">√ó</button>
            </div>
            
            <form id="editProductForm" onsubmit="handleEditProduct(event)">
                <input type="hidden" id="editProductId" name="product_id">
                
                <div class="form-group">
                    <label for="editProductName">Nombre del Producto</label>
                    <input type="text" id="editProductName" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="editProductDescription">Descripci√≥n</label>
                    <textarea id="editProductDescription" name="description" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="editProductPrice">Precio de Venta (Q)</label>
                    <input type="number" id="editProductPrice" name="price" step="0.01" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="editProductCostPrice">Precio de Costo (Q)</label>
                    <input type="number" id="editProductCostPrice" name="cost_price" step="0.01" min="0" required>
                    <small style="color: #666; font-size: 12px;">Este precio se usa para calcular las ganancias reales</small>
                </div>
                
                <div class="form-group">
                    <label for="editProductCategory">Categor√≠a</label>
                    <select id="editProductCategory" name="category" required>
                        <option value="">Seleccionar categor√≠a</option>
                        <option value="especial">Especial</option>
                        <option value="tradicional">Tradicional</option>
                        <option value="organico">Org√°nico</option>
                        <option value="descafeinado">Descafeinado</option>
                        <option value="molido">Molido</option>
                        <option value="grano">Grano Entero</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editProductStock">Stock</label>
                    <input type="number" id="editProductStock" name="stock" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="editProductImageInput">Imagen del Producto</label>
                    <div class="image-upload-area">
                        <label for="editProductImageInput" class="upload-label">
                            üì∑ Cambiar imagen
                        </label>
                        <input type="file" id="editProductImageInput" accept="image/*" onchange="previewEditImage(event)">
                    </div>
                    <img id="editImagePreview" class="image-preview" alt="Preview" style="display: none; max-width: 200px; margin-top: 10px;">
                </div>
                
                <button type="submit" class="btn btn-primary btn-full">
                    Actualizar Producto
                </button>
            </form>
        </div>
    </div>

    <!-- Modal para Crear Empleado -->
    <div id="createEmployeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Crear Nuevo Empleado</h2>
                <button class="close-modal" onclick="closeModal('createEmployeeModal')">√ó</button>
            </div>
            
            <form id="createEmployeeForm" onsubmit="handleCreateEmployee(event)">
                <div class="form-group">
                    <label for="employeeName">Nombre Completo</label>
                    <input type="text" id="employeeName" name="employee_name" required>
                </div>
                
                <div class="form-group">
                    <label for="employeeEmail">Email</label>
                    <input type="email" id="employeeEmail" name="employee_email" required>
                </div>
                
                <div class="form-group">
                    <label for="employeePassword">Contrase√±a</label>
                    <input type="password" id="employeePassword" name="employee_password" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label for="employeeRole">Rol</label>
                    <select id="employeeRole" name="employee_role" required>
                        <option value="employee">Empleado</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="adminPassword">Tu Contrase√±a (Confirmaci√≥n)</label>
                    <input type="password" id="adminPassword" name="admin_password" required 
                           placeholder="Ingresa tu contrase√±a para confirmar">
                </div>
                
                <button type="submit" class="btn btn-primary btn-full">
                    Crear Empleado
                </button>
            </form>
        </div>
    </div>

    <!-- Modal para Editar Estado de Orden -->
    <div id="editOrderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Gestionar Orden</h2>
                <button class="close-modal" onclick="closeModal('editOrderModal')">√ó</button>
            </div>
            
            <div class="modal-body">
                <div id="orderDetails">
                    <!-- Los detalles de la orden se cargar√°n aqu√≠ -->
                </div>
                
                <form id="editOrderForm" onsubmit="handleUpdateOrder(event)">
                    <div class="form-group">
                        <label for="orderStatus">Estado del Pedido</label>
                        <select id="orderStatus" name="status" required>
                            <option value="pending">Pendiente</option>
                            <option value="processing">En Proceso</option>
                            <option value="shipped">Enviado</option>
                            <option value="delivered">Entregado</option>
                            <option value="cancelled">Cancelado</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentStatus">Estado del Pago</label>
                        <select id="paymentStatus" name="payment_status" required>
                            <option value="pending">Pendiente</option>
                            <option value="confirmed">Confirmado</option>
                            <option value="failed">Fallido</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="orderNotes">Notas de Log√≠stica</label>
                        <textarea id="orderNotes" name="notes" rows="3" placeholder="Agregar notas sobre el env√≠o o log√≠stica..."></textarea>
                    </div>
                    
                    <input type="hidden" id="editOrderId" name="order_id">
                    
                    <button type="submit" class="btn btn-primary btn-full">
                        Actualizar Orden
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- EmailJS para env√≠o de correos -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <script src="{{ url_for('static', filename='js/firebase-app.js') }}"></script>
    <script>
        // Variables globales para el panel de administraci√≥n
        let adminProducts = [];
        let adminOrders = [];
        let adminStats = {
            totalCustomers: 0,
            totalEmployees: 0,
            totalRevenue: 0,
            totalProducts: 0,
            totalOrders: 0
        };

        // Verificar que el usuario sea admin o empleado
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar Firebase primero
            initializeFirebase();
        });

        // Verificar permisos de administrador
        function checkAdminPermissions() {
            if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'employee')) {
                showNotification('No tienes permisos para acceder a esta p√°gina', 'error');
                window.location.href = '/';
                return false;
            }
            return true;
        }

        // Cargar datos del panel de administraci√≥n
        async function loadAdminData() {
            if (!checkAdminPermissions()) return;

            try {
                await Promise.all([
                    loadAdminProducts(),
                    loadAdminOrders(),
                    loadAdminStats()
                ]);
            } catch (error) {
                console.error('Error cargando datos del admin:', error);
                showNotification('Error cargando datos del panel', 'error');
            }
        }

        // Override del listener de auth para admin
        function setupAdminAuth() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    await loadUserData(user);
                    if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'employee')) {
                        await loadAdminData();
                        
                        // Mostrar secci√≥n de empleados solo para admins
                        if (currentUser.role === 'admin') {
                            document.getElementById('employeesSection').style.display = 'block';
                        }
                        updateUI();
                    } else {
                        showNotification('No tienes permisos para acceder a esta p√°gina', 'error');
                        window.location.href = '/';
                    }
                } else {
                    window.location.href = '/login';
                }
            });
        }

        // Inicializar auth espec√≠fico para admin despu√©s de que Firebase est√© listo
        setTimeout(() => {
            if (auth) {
                setupAdminAuth();
            }
        }, 1000);

        // Cargar productos para administraci√≥n
        async function loadAdminProducts() {
            try {
                const productsSnapshot = await db.collection('products').orderBy('createdAt', 'desc').get();
                adminProducts = [];
                
                productsSnapshot.forEach(doc => {
                    adminProducts.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                renderAdminProducts();
            } catch (error) {
                console.error('Error cargando productos:', error);
                showNotification('Error cargando productos', 'error');
            }
        }

        // Renderizar productos en el panel de administraci√≥n
        function renderAdminProducts() {
            const tbody = document.getElementById('productsTableBody');
            if (!tbody) return;

            if (adminProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No hay productos registrados</td></tr>';
                return;
            }

            tbody.innerHTML = adminProducts.map(product => {
                const stockStatus = getStockStatus(product.stock);
                return `
                    <tr>
                        <td>
                            <img src="${product.imageUrl || '/static/img/placeholder.jpg'}" 
                                 alt="${product.name}" class="product-table-image">
                        </td>
                        <td>
                            <div class="product-table-name">${product.name}</div>
                            <div style="font-size: 12px; color: #6c757d; margin-top: 4px;">
                                ${product.description ? product.description.substring(0, 50) + '...' : ''}
                            </div>
                        </td>
                        <td>
                            <span style="text-transform: capitalize;">${product.category}</span>
                        </td>
                        <td class="product-table-price">Q${product.price.toFixed(2)}</td>
                        <td class="product-table-stock">${product.stock} unidades</td>
                        <td>
                            <span class="stock-status ${stockStatus.class}">
                                ${stockStatus.text}
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-small" onclick="editProduct('${product.id}')">
                                    Editar
                                </button>
                                <button class="btn btn-danger btn-small" onclick="deleteProduct('${product.id}')">
                                    Eliminar
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Funci√≥n para obtener el estado del stock
        function getStockStatus(stock) {
            if (stock === 0) {
                return { class: 'stock-out', text: 'Agotado' };
            } else if (stock <= 5) {
                return { class: 'stock-low', text: 'Bajo' };
            } else {
                return { class: 'stock-available', text: 'Disponible' };
            }
        }

        // Cargar √≥rdenes para administraci√≥n
        async function loadAdminOrders() {
            try {
                const ordersSnapshot = await db.collection('orders').orderBy('createdAt', 'desc').limit(20).get();
                adminOrders = [];
                
                ordersSnapshot.forEach(doc => {
                    adminOrders.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                renderAdminOrders();
            } catch (error) {
                console.error('Error cargando √≥rdenes:', error);
                showNotification('Error cargando √≥rdenes', 'error');
            }
        }

        // Renderizar √≥rdenes en el panel de administraci√≥n
        function renderAdminOrders() {
            const tbody = document.getElementById('ordersTableBody');
            if (!tbody) return;

            if (adminOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay √≥rdenes registradas</td></tr>';
                return;
            }

            tbody.innerHTML = adminOrders.map(order => `
                <tr>
                    <td>#${order.id.substring(0, 8)}</td>
                    <td>${order.customerName || 'N/A'}</td>
                    <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                    <td>Q${order.total.toFixed(2)}</td>
                    <td>
                        <span class="status-badge status-${order.status || 'pending'}">
                            ${getStatusText(order.status || 'pending')}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-secondary btn-small" onclick="editOrder('${order.id}')">
                            Gestionar
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Cargar estad√≠sticas del panel
        async function loadAdminStats() {
            try {
                // Cargar estad√≠sticas desde Firestore
                const [customersSnapshot, employeesSnapshot, ordersSnapshot, productsSnapshot] = await Promise.all([
                    db.collection('users').where('role', '==', 'customer').get(),
                    db.collection('users').where('role', 'in', ['admin', 'employee']).get(),
                    db.collection('orders').get(),
                    db.collection('products').get()
                ]);

                // Calcular estad√≠sticas
                adminStats.totalCustomers = customersSnapshot.size;
                adminStats.totalEmployees = employeesSnapshot.size;
                adminStats.totalProducts = productsSnapshot.size;
                adminStats.totalOrders = ordersSnapshot.size;

                // Crear mapa de productos para acceso r√°pido
                const productsMap = {};
                productsSnapshot.forEach(doc => {
                    const product = doc.data();
                    productsMap[doc.id] = product;
                });

                // Calcular ganancias reales y totales
                let totalRevenue = 0;
                let totalProfit = 0;
                let totalCost = 0;
                
                ordersSnapshot.forEach(doc => {
                    const order = doc.data();
                    if (order.status === 'delivered' && order.total) {
                        totalRevenue += order.total;
                        
                        // Calcular costo y ganancia por pedido
                        if (order.items) {
                            order.items.forEach(item => {
                                const product = productsMap[item.productId];
                                if (product && product.costPrice) {
                                    const itemCost = product.costPrice * item.quantity;
                                    const itemProfit = (item.price - product.costPrice) * item.quantity;
                                    totalCost += itemCost;
                                    totalProfit += itemProfit;
                                }
                            });
                        }
                    }
                });
                
                adminStats.totalRevenue = totalRevenue;
                adminStats.totalProfit = totalProfit;
                adminStats.totalCost = totalCost;

                renderAdminStats();
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
                showNotification('Error cargando estad√≠sticas', 'error');
            }
        }

        // Renderizar estad√≠sticas
        function renderAdminStats() {
            document.getElementById('totalCustomers').textContent = adminStats.totalCustomers;
            document.getElementById('totalEmployees').textContent = adminStats.totalEmployees;
            document.getElementById('totalRevenue').textContent = `Q${adminStats.totalRevenue.toFixed(2)}`;
            document.getElementById('totalProfit').textContent = `Q${(adminStats.totalProfit || 0).toFixed(2)}`;
            document.getElementById('totalProducts').textContent = adminStats.totalProducts;
            document.getElementById('totalOrders').textContent = adminStats.totalOrders;
        }

        // Mostrar modal para agregar producto
        function showAddProductModal() {
            document.getElementById('addProductForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            showModal('addProductModal');
        }

        // Manejar agregar producto
        async function handleAddProduct(event) {
            event.preventDefault();
            
            if (!checkAdminPermissions() || isLoading) return;

            try {
                isLoading = true;
                showNotification('Agregando producto...', 'warning');

                const formData = new FormData(event.target);
                const imageFile = document.getElementById('productImageInput').files[0];

                let imageUrl = '';
                if (imageFile) {
                    // Subir imagen a Firebase Storage
                    const storageRef = storage.ref(`products/${Date.now()}_${imageFile.name}`);
                    const snapshot = await storageRef.put(imageFile);
                    imageUrl = await snapshot.ref.getDownloadURL();
                }

                // Crear producto en Firestore
                const productData = {
                    name: formData.get('name'),
                    description: formData.get('description'),
                    price: parseFloat(formData.get('price')),
                    costPrice: parseFloat(formData.get('cost_price')),
                    category: formData.get('category'),
                    stock: parseInt(formData.get('stock')),
                    imageUrl: imageUrl,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.uid
                };

                await db.collection('products').add(productData);

                showNotification('Producto agregado exitosamente', 'success');
                closeModal('addProductModal');
                await loadAdminProducts();
                await loadAdminStats();

            } catch (error) {
                console.error('Error agregando producto:', error);
                showNotification('Error agregando producto: ' + error.message, 'error');
            } finally {
                isLoading = false;
            }
        }

        // Previsualizar imagen
        function previewImage(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('imagePreview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        }

        // Eliminar producto
        async function deleteProduct(productId) {
            if (!checkAdminPermissions()) return;

            if (!confirm('¬øEst√°s seguro de que quieres eliminar este producto?')) {
                return;
            }

            try {
                await db.collection('products').doc(productId).delete();
                showNotification('Producto eliminado exitosamente', 'success');
                await loadAdminProducts();
                await loadAdminStats();
            } catch (error) {
                console.error('Error eliminando producto:', error);
                showNotification('Error eliminando producto', 'error');
            }
        }

        // Editar producto
        function editProduct(productId) {
            const product = adminProducts.find(p => p.id === productId);
            if (!product) {
                showNotification('Producto no encontrado', 'error');
                return;
            }

            // Llenar el modal con los datos del producto
            document.getElementById('editProductId').value = productId;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductDescription').value = product.description || '';
            document.getElementById('editProductPrice').value = product.price;
            document.getElementById('editProductCostPrice').value = product.costPrice || 0;
            document.getElementById('editProductCategory').value = product.category;
            document.getElementById('editProductStock').value = product.stock;
            
            // Mostrar imagen actual si existe
            const imagePreview = document.getElementById('editImagePreview');
            if (product.imageUrl) {
                imagePreview.src = product.imageUrl;
                imagePreview.style.display = 'block';
            } else {
                imagePreview.style.display = 'none';
            }

            showModal('editProductModal');
        }

        // Manejar actualizaci√≥n de producto
        async function handleEditProduct(event) {
            event.preventDefault();
            
            if (!checkAdminPermissions() || isLoading) return;

            try {
                isLoading = true;
                showNotification('Actualizando producto...', 'warning');

                const formData = new FormData(event.target);
                const productId = formData.get('product_id');
                const imageFile = document.getElementById('editProductImageInput').files[0];

                let updateData = {
                    name: formData.get('name'),
                    description: formData.get('description'),
                    price: parseFloat(formData.get('price')),
                    costPrice: parseFloat(formData.get('cost_price')),
                    category: formData.get('category'),
                    stock: parseInt(formData.get('stock')),
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.uid
                };

                // Si hay nueva imagen, subirla
                if (imageFile) {
                    const storageRef = storage.ref(`products/${Date.now()}_${imageFile.name}`);
                    const snapshot = await storageRef.put(imageFile);
                    updateData.imageUrl = await snapshot.ref.getDownloadURL();
                }

                await db.collection('products').doc(productId).update(updateData);

                showNotification('Producto actualizado exitosamente', 'success');
                closeModal('editProductModal');
                await loadAdminProducts();
                await loadAdminStats();

            } catch (error) {
                console.error('Error actualizando producto:', error);
                showNotification('Error actualizando producto: ' + error.message, 'error');
            } finally {
                isLoading = false;
            }
        }

        // Previsualizar imagen en modal de edici√≥n
        function previewEditImage(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('editImagePreview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        // Editar orden
        function editOrder(orderId) {
            const order = adminOrders.find(o => o.id === orderId);
            if (!order) return;

            // Llenar el modal con los datos de la orden
            document.getElementById('editOrderId').value = orderId;
            document.getElementById('orderStatus').value = order.status || 'pending';
            document.getElementById('paymentStatus').value = order.paymentStatus || 'pending';
            document.getElementById('orderNotes').value = order.notes || '';

            // Mostrar detalles de la orden
            const orderDetails = document.getElementById('orderDetails');
            
            // Generar lista de productos
            let itemsHtml = '';
            if (order.items && order.items.length > 0) {
                itemsHtml = `
                    <div class="order-items">
                        <h4>Productos del Pedido:</h4>
                        <div class="items-list">
                `;
                
                order.items.forEach(item => {
                    itemsHtml += `
                        <div class="item-row">
                            <div class="item-info">
                                <span class="item-name">${item.name}</span>
                                <span class="item-details">Cantidad: ${item.quantity} | Precio: Q${item.price.toFixed(2)} | Subtotal: Q${item.subtotal.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                });
                
                itemsHtml += `
                        </div>
                    </div>
                `;
            } else {
                itemsHtml = '<div class="order-items"><p>No se encontraron productos en este pedido.</p></div>';
            }
            
            orderDetails.innerHTML = `
                <div class="order-summary">
                    <h3>Orden #${order.id.substring(0, 8)}</h3>
                    <div class="customer-info">
                        <h4>Informaci√≥n del Cliente:</h4>
                        <p><strong>Cliente:</strong> ${order.customerName || 'N/A'}</p>
                        <p><strong>Email:</strong> ${order.customerEmail || 'N/A'}</p>
                        <p><strong>Tel√©fono:</strong> ${order.customerPhone || 'N/A'}</p>
                        <p><strong>Direcci√≥n:</strong> ${order.customerAddress || 'N/A'}</p>
                        <p><strong>Notas del Cliente:</strong> ${order.customerNotes || 'Sin notas adicionales'}</p>
                    </div>
                    ${itemsHtml}
                    <div class="order-totals">
                        <p><strong>Total del Pedido:</strong> Q${order.total.toFixed(2)}</p>
                        <p><strong>Fecha:</strong> ${new Date(order.createdAt).toLocaleString()}</p>
                    </div>
                </div>
                <style>
                    .order-summary { margin-bottom: 20px; }
                    .customer-info, .order-items, .order-totals { 
                        margin: 15px 0; 
                        padding: 10px; 
                        border: 1px solid #ddd; 
                        border-radius: 5px; 
                        background-color: #f9f9f9; 
                    }
                    .customer-info h4, .order-items h4 { 
                        margin-top: 0; 
                        color: #8B4513; 
                        border-bottom: 1px solid #ddd; 
                        padding-bottom: 5px; 
                    }
                    .item-row { 
                        padding: 8px 0; 
                        border-bottom: 1px solid #eee; 
                    }
                    .item-row:last-child { border-bottom: none; }
                    .item-name { 
                        font-weight: bold; 
                        display: block; 
                        color: #333; 
                    }
                    .item-details { 
                        font-size: 0.9em; 
                        color: #666; 
                        display: block; 
                        margin-top: 3px; 
                    }
                    .order-totals { 
                        background-color: #e8f5e8; 
                        border-color: #4CAF50; 
                    }
                    .order-totals p { margin: 5px 0; }
                </style>
            `;

            showModal('editOrderModal');
        }

        // Manejar actualizaci√≥n de orden
        async function handleUpdateOrder(event) {
            event.preventDefault();
            
            if (!checkAdminPermissions() || isLoading) return;

            try {
                isLoading = true;
                showNotification('Actualizando orden...', 'warning');

                const formData = new FormData(event.target);
                const orderId = formData.get('order_id');

                // Obtener datos actuales del pedido para comparar
                const orderDoc = await db.collection('orders').doc(orderId).get();
                const currentOrder = orderDoc.data();
                const previousStatus = currentOrder.status;

                const updateData = {
                    status: formData.get('status'),
                    paymentStatus: formData.get('payment_status'),
                    notes: formData.get('notes'),
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.uid
                };

                // Actualizar en Firebase
                await db.collection('orders').doc(orderId).update(updateData);

                // Enviar notificaci√≥n por correo si el estado cambi√≥
                if (previousStatus !== updateData.status) {
                    await sendOrderStatusEmail(orderId, currentOrder, updateData.status);
                }

                showNotification('Orden actualizada exitosamente', 'success');
                closeModal('editOrderModal');
                await loadAdminOrders();

            } catch (error) {
                console.error('Error actualizando orden:', error);
                showNotification('Error actualizando orden', 'error');
            } finally {
                isLoading = false;
            }
        }

        // Funci√≥n para enviar notificaci√≥n por correo con EmailJS
        async function sendOrderStatusEmail(orderId, orderData, newStatus) {
            try {
                console.log('Enviando notificaci√≥n por correo para pedido:', orderId);
                
                // Inicializar EmailJS (reemplaza con tus credenciales reales)
                emailjs.init("YOUR_PUBLIC_KEY"); // Reemplazar con tu Public Key de EmailJS
                
                const statusMessages = {
                    'pending': 'Tu pedido ha sido recibido y est√° pendiente de confirmaci√≥n.',
                    'confirmed': '¬°Tu pedido ha sido confirmado! Estamos preparando tu caf√©.',
                    'processing': 'Tu pedido est√° siendo procesado y empacado.',
                    'shipped': '¬°Tu pedido ha sido enviado! Pronto lo recibir√°s.',
                    'delivered': '¬°Tu pedido ha sido entregado! Esperamos que disfrutes tu caf√©.',
                    'cancelled': 'Tu pedido ha sido cancelado. Si tienes dudas, cont√°ctanos.'
                };

                // Preparar datos para EmailJS
                const templateParams = {
                    to_email: orderData.customerEmail,
                    to_name: orderData.customerName,
                    order_id: orderId.substring(0, 8),
                    order_status: getStatusText(newStatus),
                    status_message: statusMessages[newStatus] || 'Tu pedido ha sido actualizado.',
                    order_total: `Q${orderData.total.toFixed(2)}`,
                    customer_address: orderData.customerAddress,
                    customer_phone: orderData.customerPhone,
                    customer_notes: orderData.customerNotes || 'Sin notas adicionales',
                    items_list: orderData.items.map(item => 
                        `${item.name} x ${item.quantity} - Q${item.subtotal.toFixed(2)}`
                    ).join('\n'),
                    company_name: 'Nativo Caf√©',
                    support_email: 'soporte@nativocafe.com'
                };

                console.log('Enviando correo con EmailJS:', templateParams);

                // Enviar correo real con EmailJS
                const response = await emailjs.send(
                    'YOUR_SERVICE_ID',    // Reemplazar con tu Service ID
                    'YOUR_TEMPLATE_ID',   // Reemplazar con tu Template ID
                    templateParams
                );

                console.log('Correo enviado exitosamente:', response);
                showNotification(`‚úÖ Correo enviado a ${orderData.customerEmail}`, 'success');
                
                // Guardar log del correo enviado
                await db.collection('email_logs').add({
                    orderId: orderId,
                    customerEmail: orderData.customerEmail,
                    customerName: orderData.customerName,
                    status: newStatus,
                    emailjsResponse: response.status,
                    sentAt: new Date().toISOString(),
                    sentBy: currentUser.uid,
                    templateParams: templateParams
                });

            } catch (error) {
                console.error('Error enviando correo con EmailJS:', error);
                
                // Fallback: Guardar intento fallido pero continuar
                showNotification(`‚ö†Ô∏è Error enviando correo: ${error.message}`, 'warning');
                
                try {
                    await db.collection('email_logs').add({
                        orderId: orderId,
                        customerEmail: orderData.customerEmail,
                        status: newStatus,
                        error: error.message,
                        sentAt: new Date().toISOString(),
                        sentBy: currentUser.uid,
                        success: false
                    });
                } catch (logError) {
                    console.error('Error guardando log de correo fallido:', logError);
                }
            }
        }

        // Obtener texto del estado
        function getStatusText(status) {
            const statusTexts = {
                'pending': 'Pendiente',
                'processing': 'En Proceso',
                'shipped': 'Enviado',
                'delivered': 'Entregado',
                'cancelled': 'Cancelado'
            };
            return statusTexts[status] || status;
        }

        // Mostrar modal para crear empleado
        function showCreateEmployeeModal() {
            document.getElementById('createEmployeeForm').reset();
            showModal('createEmployeeModal');
        }

        // Manejar creaci√≥n de empleado
        async function handleCreateEmployee(event) {
            event.preventDefault();
            
            if (!checkAdminPermissions() || isLoading) return;

            try {
                isLoading = true;
                showNotification('Creando empleado...', 'warning');

                const formData = new FormData(event.target);
                const employeeEmail = formData.get('employee_email');
                const employeePassword = formData.get('employee_password');
                const employeeName = formData.get('employee_name');
                const employeeRole = formData.get('employee_role');

                // Crear usuario en Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(employeeEmail, employeePassword);
                const user = userCredential.user;

                // Actualizar perfil
                await user.updateProfile({
                    displayName: employeeName
                });

                // Crear documento en Firestore
                await db.collection('users').doc(user.uid).set({
                    name: employeeName,
                    email: employeeEmail,
                    role: employeeRole,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.uid,
                    photoURL: null
                });

                showNotification('Empleado creado exitosamente', 'success');
                closeModal('createEmployeeModal');
                await loadAdminStats();

            } catch (error) {
                console.error('Error creando empleado:', error);
                let errorMessage = 'Error creando empleado';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Este email ya est√° registrado';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'La contrase√±a debe tener al menos 6 caracteres';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Email inv√°lido';
                        break;
                    default:
                        errorMessage = error.message;
                }
                
                showNotification(errorMessage, 'error');
            } finally {
                isLoading = false;
            }
        }
    </script>
</body>
</html>

