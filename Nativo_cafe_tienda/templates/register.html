<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro - Nativo Caf√©</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        .verification-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            color: #856404;
        }
        
        .verification-notice h4 {
            margin: 0 0 8px 0;
            color: #856404;
        }
        
        .verification-notice p {
            margin: 0;
            font-size: 14px;
        }
        
        .resend-verification {
            background: none;
            border: none;
            color: #007bff;
            text-decoration: underline;
            cursor: pointer;
            font-size: 14px;
            margin-top: 8px;
        }
        
        .resend-verification:hover {
            color: #0056b3;
        }
        
        .email-verified {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
    </style>
</head>
<body>
    <!-- Notificaci√≥n -->
    <div id="notification" class="notification"></div>
    
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-logo">‚òï</div>
            <h1 class="auth-title">Crear Cuenta</h1>
            <p class="auth-subtitle">√önete a la familia Nativo Caf√©</p>
            
            <div id="errorMessage" class="error-message" style="display: none;"></div>
            <div id="successMessage" class="success-message" style="display: none;"></div>
            
            <!-- Aviso de verificaci√≥n de email -->
            <div id="verificationNotice" class="verification-notice" style="display: none;">
                <h4>üìß Verifica tu correo electr√≥nico</h4>
                <p>Hemos enviado un enlace de verificaci√≥n a tu correo. Por favor verifica tu email antes de continuar.</p>
                <button class="resend-verification" onclick="resendVerificationEmail()">
                    Reenviar email de verificaci√≥n
                </button>
            </div>
            
            <form id="registerForm">
                <div class="form-group">
                    <label for="name">Nombre Completo</label>
                    <input type="text" id="name" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="email">Correo Electr√≥nico</label>
                    <input type="email" id="email" name="email" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Contrase√±a</label>
                    <input type="password" id="password" name="password" required minlength="6">
                    <small>M√≠nimo 6 caracteres</small>
                </div>
                
                <div class="form-group">
                    <label for="confirm_password">Confirmar Contrase√±a</label>
                    <input type="password" id="confirm_password" name="confirm_password" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="emailVerificationConsent" required>
                        Acepto recibir emails de verificaci√≥n y notificaciones importantes
                    </label>
                </div>
                
                <button type="submit" class="btn btn-primary btn-full" id="registerBtn">
                    Crear Cuenta
                </button>
            </form>
            
            <div class="auth-link">
                ¬øYa tienes cuenta? <a href="/login">Inicia Sesi√≥n</a>
            </div>
        </div>
    </div>
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBR15MaGdT7JpTh0C3w1r1NkI8wmoSQRJU",
            authDomain: "nativo-cafe-tienda-85377.firebaseapp.com",
            projectId: "nativo-cafe-tienda-85377",
            storageBucket: "nativo-cafe-tienda-85377.firebasestorage.app",
            messagingSenderId: "1034154213401",
            appId: "1:1034154213401:web:5b654e7d816c875956aa88",
            measurementId: "G-CE58R1VV8F"
        };

        // Inicializar Firebase
        let app, auth, db;
        let currentUser = null;
        
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log('‚úÖ Firebase inicializado correctamente');
        } catch (error) {
            console.error('‚ùå Error inicializando Firebase:', error);
            showNotification('Error de configuraci√≥n. Verifica tu conexi√≥n a internet.', 'error');
        }

        // Funci√≥n para mostrar notificaciones
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = message;
                notification.className = `notification ${type} show`;
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 5000);
            }
        }

        // Funci√≥n para mostrar errores
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
            showNotification(message, 'error');
        }

        // Funci√≥n para mostrar √©xito
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            if (successDiv) {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
            }
            showNotification(message, 'success');
        }

        // Funci√≥n para limpiar mensajes
        function clearMessages() {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            if (errorDiv) errorDiv.style.display = 'none';
            if (successDiv) successDiv.style.display = 'none';
        }

        // Funci√≥n para mostrar aviso de verificaci√≥n
        function showVerificationNotice() {
            const notice = document.getElementById('verificationNotice');
            const form = document.getElementById('registerForm');
            
            if (notice && form) {
                notice.style.display = 'block';
                form.style.display = 'none';
            }
        }

        // Funci√≥n para ocultar aviso de verificaci√≥n
        function hideVerificationNotice() {
            const notice = document.getElementById('verificationNotice');
            const form = document.getElementById('registerForm');
            
            if (notice && form) {
                notice.style.display = 'none';
                form.style.display = 'block';
            }
        }

        // Funci√≥n de registro con verificaci√≥n de email
        async function registerUser(email, password, name) {
            try {
                console.log('üîÑ Iniciando registro para:', email);
                
                // Verificar que Firebase est√© inicializado
                if (!auth) {
                    throw new Error('Firebase no est√° inicializado');
                }

                showNotification('Creando cuenta...', 'warning');
                
                // Crear usuario en Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                console.log('‚úÖ Usuario creado en Auth:', user.uid);

                // Actualizar perfil del usuario
                await user.updateProfile({
                    displayName: name
                });

                console.log('‚úÖ Perfil actualizado');

                // Enviar email de verificaci√≥n
                await user.sendEmailVerification({
                    url: window.location.origin + '/login',
                    handleCodeInApp: false
                });

                console.log('‚úÖ Email de verificaci√≥n enviado');

                // Crear documento en Firestore
                const userData = {
                    name: name,
                    email: email,
                    role: 'customer',
                    emailVerified: false,
                    createdAt: new Date().toISOString(),
                    photoURL: null
                };

                await db.collection('users').doc(user.uid).set(userData);
                console.log('‚úÖ Usuario guardado en Firestore');

                // Mostrar mensaje de verificaci√≥n
                showSuccess('¬°Cuenta creada exitosamente! Revisa tu correo para verificar tu email.');
                showVerificationNotice();
                
                // Guardar referencia del usuario actual
                currentUser = user;

            } catch (error) {
                console.error('‚ùå Error en registro:', error);
                
                let errorMessage = 'Error al crear la cuenta';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Este correo ya est√° registrado. Intenta iniciar sesi√≥n.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'La contrase√±a debe tener al menos 6 caracteres.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'El correo electr√≥nico no es v√°lido.';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Error de conexi√≥n. Verifica tu internet.';
                        break;
                    default:
                        errorMessage = error.message || 'Error desconocido al crear la cuenta';
                }
                
                showError(errorMessage);
            }
        }

        // Funci√≥n para reenviar email de verificaci√≥n
        async function resendVerificationEmail() {
            if (!currentUser) {
                showError('No hay usuario para reenviar verificaci√≥n');
                return;
            }

            try {
                await currentUser.sendEmailVerification({
                    url: window.location.origin + '/login',
                    handleCodeInApp: false
                });
                
                showSuccess('Email de verificaci√≥n reenviado. Revisa tu bandeja de entrada.');
            } catch (error) {
                console.error('Error reenviando email:', error);
                showError('Error al reenviar email de verificaci√≥n');
            }
        }

        // Verificar estado de verificaci√≥n de email
        function checkEmailVerification() {
            if (auth.currentUser) {
                auth.currentUser.reload().then(() => {
                    if (auth.currentUser.emailVerified) {
                        // Actualizar estado en Firestore
                        db.collection('users').doc(auth.currentUser.uid).update({
                            emailVerified: true
                        }).then(() => {
                            showSuccess('¬°Email verificado exitosamente! Redirigiendo...');
                            setTimeout(() => {
                                window.location.href = '/';
                            }, 2000);
                        });
                    }
                });
            }
        }

        // Event listener para el formulario
        document.addEventListener('DOMContentLoaded', function() {
            const registerForm = document.getElementById('registerForm');
            const registerBtn = document.getElementById('registerBtn');
            
            if (registerForm) {
                registerForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    clearMessages();
                    
                    // Deshabilitar bot√≥n
                    registerBtn.disabled = true;
                    registerBtn.textContent = 'Creando cuenta...';
                    
                    try {
                        const formData = new FormData(e.target);
                        const name = formData.get('name').trim();
                        const email = formData.get('email').trim();
                        const password = formData.get('password');
                        const confirmPassword = formData.get('confirm_password');
                        const emailConsent = document.getElementById('emailVerificationConsent').checked;
                        
                        // Validaciones
                        if (!name || !email || !password || !confirmPassword) {
                            throw new Error('Todos los campos son obligatorios');
                        }
                        
                        if (!emailConsent) {
                            throw new Error('Debes aceptar recibir emails de verificaci√≥n');
                        }
                        
                        if (password !== confirmPassword) {
                            throw new Error('Las contrase√±as no coinciden');
                        }
                        
                        if (password.length < 6) {
                            throw new Error('La contrase√±a debe tener al menos 6 caracteres');
                        }
                        
                        // Registrar usuario
                        await registerUser(email, password, name);
                        
                    } catch (error) {
                        console.error('Error en formulario:', error);
                        showError(error.message);
                    } finally {
                        // Rehabilitar bot√≥n
                        registerBtn.disabled = false;
                        registerBtn.textContent = 'Crear Cuenta';
                    }
                });
            }

            // Verificar si el usuario ya est√° logueado
            if (auth) {
                auth.onAuthStateChanged(function(user) {
                    if (user) {
                        if (user.emailVerified) {
                            console.log('Usuario ya logueado y verificado, redirigiendo...');
                            window.location.href = '/';
                        } else {
                            console.log('Usuario logueado pero no verificado');
                            currentUser = user;
                            showVerificationNotice();
                            
                            // Verificar peri√≥dicamente si el email fue verificado
                            const verificationInterval = setInterval(() => {
                                checkEmailVerification();
                                if (user.emailVerified) {
                                    clearInterval(verificationInterval);
                                }
                            }, 3000);
                        }
                    }
                });
            }
        });

        // Verificar conexi√≥n a Firebase
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (typeof firebase === 'undefined') {
                    showError('Error: No se pudo cargar Firebase. Verifica tu conexi√≥n a internet.');
                } else if (!auth) {
                    showError('Error: Firebase Auth no se inicializ√≥ correctamente.');
                } else {
                    console.log('‚úÖ Todo listo para registrar usuarios');
                }
            }, 2000);
        });

        // Verificar peri√≥dicamente el estado de verificaci√≥n cuando hay un usuario
        setInterval(() => {
            if (currentUser && !currentUser.emailVerified) {
                checkEmailVerification();
            }
        }, 5000);
    </script>
</body>
</html>

